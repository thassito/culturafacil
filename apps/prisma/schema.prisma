generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  agent       Agent?
  evaluations Evaluation[]
  opportunities Opportunity[]

  @@map("users")
}

model Agent {
  id         String    @id @default(uuid())
  userId     String    @unique @map("user_id")
  name       String?
  cpf        String    @unique // Adicionado campo CPF
  type       AgentType?
  bio        String?
  phone      String?
  website    String?
  avatarUrl  String?   @map("avatar_url")
  isVerified Boolean   @default(false) @map("is_verified")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  deletedAt  DateTime? @map("deleted_at")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  registrations Registration[]

  @@map("agents")
}

enum AgentType {
  individual
  collective
  organization
}

model Opportunity {
  id               String            @id @default(uuid())
  name             String
  description      String?
  type             OpportunityType
  status           OpportunityStatus @default(draft)
  registrationFrom DateTime          @map("registration_from")
  registrationTo   DateTime          @map("registration_to")
  resultAnnouncedAt DateTime?        @map("result_announced_at")
  maxRegistrations Int?              @map("max_registrations")
  budget           Decimal?          @db.Decimal(15, 2)
  formSchema       Json              @default("{}") @map("form_schema")
  resultJson       Json?             @map("result_json")
  createdById      String            @map("created_by_id")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  deletedAt        DateTime?         @map("deleted_at")

  createdBy     User           @relation(fields: [createdById], references: [id])
  registrations Registration[]

  @@map("opportunities")
}

enum OpportunityType {
  editais
  chamada_publica
  inscricao_continua
}

enum OpportunityStatus {
  draft
  published
  closed
  evaluation
  result
  archived
}

model Registration {
  id            String             @id @default(uuid())
  opportunityId String             @map("opportunity_id")
  agentId       String             @map("agent_id")
  status        RegistrationStatus @default(draft)
  data          Json               @default("{}")
  submittedAt   DateTime?          @map("submitted_at")
  score         Decimal?           @db.Decimal(5, 2)
  notes         String?
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")
  deletedAt     DateTime?          @map("deleted_at")

  opportunity Opportunity  @relation(fields: [opportunityId], references: [id])
  agent       Agent        @relation(fields: [agentId], references: [id])
  attachments Attachment[]
  evaluations Evaluation[]

  @@unique([opportunityId, agentId])
  @@map("registrations")
}

enum RegistrationStatus {
  draft
  submitted
  ineligible
  eligible
  under_evaluation
  approved
  rejected
  claim
}

model Attachment {
  id             String   @id @default(uuid())
  registrationId String   @map("registration_id")
  fieldName      String   @map("field_name")
  fileUrl        String   @map("file_url")
  fileSize       Int      @map("file_size")
  mimeType       String?  @map("mime_type")
  createdAt      DateTime @default(now()) @map("created_at")

  registration Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  @@map("attachments")
}

model Evaluation {
  id             String           @id @default(uuid())
  registrationId String           @map("registration_id")
  evaluatorId    String           @map("evaluator_id")
  score          Decimal          @db.Decimal(5, 2)
  comment        String?
  result         EvaluationResult @default(pending)
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  registration Registration @relation(fields: [registrationId], references: [id])
  evaluator    User         @relation(fields: [evaluatorId], references: [id])

  @@map("evaluations")
}

enum EvaluationResult {
  pending
  approved
  rejected
}
